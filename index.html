<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>いんむごろくC Playground</title>
  <style>
    body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; }
    #editor { flex: 1; box-sizing: border-box; padding: 1em; font-family: monospace; font-size: 14px; }
    #pane { width: 40%; border-left: 1px solid #ccc; box-sizing: border-box; padding: 1em; }
    #output { white-space: pre; background: #f8f8f8; padding: .5em; height: calc(100% - 2.5em); overflow: auto; }
    textarea { width: 100%; height: 100%; resize: none; }
    button { margin-bottom: .5em; }
  </style>
</head>
<body>
  <div id="editor">
    <textarea id="code">
草 引数 n の二乗を返す

いいよ、来いよ！胸にかけて！ square(n) ンアー
おう、考えてやるよ n * n ンアー

いいよ、来いよ！胸にかけて！ main() ンアー
ん～いいときには結構いくね i = 1 ンアー
暴れんなよ i <= 5 ずっと
  逝くぞ "square(%d) = %d\n", i, square(i) ンアー
  ん～いいときには結構いくね i = i + 1 ンアー
おう、考えてやるよ 0 ンアー
    </textarea>
  </div>
  <div id="pane">
    <button id="runBtn">実行</button>
    <h3>出力</h3>
    <div id="output"></div>
  </div>

  <script>
    //─── いんむごろくC インタプリタ ───────────────────────────
    function interpret(src, print) {
      const lines = src.split(/\r?\n/);
      const stmts = [];
      for (let raw of lines) {
        const line = raw.trim();
        if (!line) continue;
        if (/^いいよ.*?([A-Za-z_]\w*)\(\)ンアー$/.test(line)) {
          const name = line.match(/^いいよ.*?([A-Za-z_]\w*)\(\)ンアー$/)[1];
          stmts.push({ type:'func_start', name });
          continue;
        }
        if (/^おう、考えてやるよ/.test(line)) {
          const expr = line.replace(/^おう、考えてやるよ\s*/, '').replace(/ンアー$/, '');
          stmts.push({ type:'return', expr });
          stmts.push({ type:'func_end' });
          continue;
        }
        if (/^ん～いいときには結構いくね/.test(line)) {
          const rest = line.replace(/^ん～いいときには結構いくね\s*/, '').replace(/ンアー$/, '');
          stmts.push({ type:'var_decl', code: rest });
          continue;
        }
        if (/^ファッ！？/.test(line)) {
          const cond = line.replace(/^ファッ！？\s*/, '').replace(/\s*なら$/, '');
          stmts.push({ type:'if', cond });
          continue;
        }
        if (/^大丈夫でしょ/.test(line)) {
          stmts.push({ type:'else' });
          continue;
        }
        if (/^暴れんなよ/.test(line)) {
          const cond = line.replace(/^暴れんなよ\s*/, '').replace(/\s*ずっと$/, '');
          stmts.push({ type:'while', cond });
          continue;
        }
        if (/^逝くぞ/.test(line)) {
          const args = line.replace(/^逝くぞ\s*/, '').replace(/ンアー$/, '');
          stmts.push({ type:'call', args });
          continue;
        }
      }

      const env = { functions: {}, vars: {} };
      // 関数定義をスキャン
      stmts.forEach((s, i) => {
        if (s.type === 'func_start') env.functions[s.name] = i + 1;
      });

      function evalExpr(expr) {
        try {
          const f = new Function('vars', 'with(vars){return ' + expr + '}');
          return f(env.vars);
        } catch {
          return expr;
        }
      }

      function callFunction(name) {
        let i = env.functions[name];
        const loopStack = [];
        while (i < stmts.length) {
          const s = stmts[i];
          switch (s.type) {
            case 'var_decl':
              {
                const [v,e] = s.code.split(/\s*=\s*/);
                env.vars[v] = evalExpr(e);
              }
              i++; break;
            case 'if':
              if (evalExpr(s.cond)) { i++; }
              else {
                while (i < stmts.length && stmts[++i].type !== 'else');
                i++;
              }
              break;
            case 'else':
              i++; break;
            case 'while':
              if (evalExpr(s.cond)) {
                loopStack.push(i);
                i++;
              } else {
                // skip to end of loop
                let depth = 1;
                while (depth && ++i < stmts.length) {
                  if (stmts[i].type === 'while') depth++;
                  if (stmts[i].type === 'func_end') depth--;
                }
                i++;
              }
              break;
            case 'call':
              let out = s.args;
              if (/^".*"$/.test(out)) out = out.slice(1, -1);
              print(out);
              i++; break;
            case 'return':
              return;
            case 'func_end':
              if (loopStack.length) {
                i = loopStack.pop();
              } else return;
            default:
              i++; break;
          }
        }
      }

      if (env.functions.main != null) {
        callFunction('main');
      }
    }

    //─── ボタン動作 ───────────────────────────────────────
    document.getElementById('runBtn').onclick = () => {
      const src = document.getElementById('code').value;
      const outEl = document.getElementById('output');
      outEl.textContent = '';
      interpret(src, msg => outEl.textContent += msg + "\n");
    };
  </script>
</body>
</html>
